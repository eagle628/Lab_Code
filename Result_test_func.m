clear
close all

S1 = load('C:\Users\NaoyaInoue\Desktop\figure_set\model_update\data\node30_noise10_number1initial_flag1');
S2 = load('C:\Users\NaoyaInoue\Desktop\figure_set\model_update\data\node30_noise10_number2initial_flag1');
S3 = load('C:\Users\NaoyaInoue\Desktop\figure_set\model_update\data\node30_noise10_number3initial_flag1');
S4 = load('C:\Users\NaoyaInoue\Desktop\figure_set\model_update\data\node30_noise10_number4initial_flag1');
S5 = load('C:\Users\NaoyaInoue\Desktop\figure_set\model_update\data\node30_noise10_number5initial_flag1');
S6 = load('C:\Users\NaoyaInoue\Desktop\figure_set\model_update\data\node30_noise10_number6initial_flag1');

%% RSME
rmse_oe_ss1 = RMSE(...
                    S1.ytilde_ini_oe_ss(:,2),...
                    S2.ytilde_ini_oe_ss(:,2),...
                    S3.ytilde_ini_oe_ss(:,2),...
                    S4.ytilde_ini_oe_ss(:,2),...
                    S5.ytilde_ini_oe_ss(:,2),...
                    S6.ytilde_ini_oe_ss(:,2)...
                    );
rmse_oe_ss2 = RMSE(...
                    S1.ytilde_sec_oe_ss(:,2),...
                    S2.ytilde_sec_oe_ss(:,2),...
                    S3.ytilde_sec_oe_ss(:,2),...
                    S4.ytilde_sec_oe_ss(:,2),...
                    S5.ytilde_sec_oe_ss(:,2),...
                    S6.ytilde_sec_oe_ss(:,2)...
                    );
rmse_oe_ss3 = RMSE(...
                    S1.ytilde_thi_oe_ss(:,2),...
                    S2.ytilde_thi_oe_ss(:,2),...
                    S3.ytilde_thi_oe_ss(:,2),...
                    S4.ytilde_thi_oe_ss(:,2),...
                    S5.ytilde_thi_oe_ss(:,2),...
                    S6.ytilde_thi_oe_ss(:,2)...
                    );

rmse_oe_tf1 = RMSE(...
                    S1.ytilde_ini_oe_tf(:,2),...
                    S2.ytilde_ini_oe_tf(:,2),...
                    S3.ytilde_ini_oe_tf(:,2),...
                    S4.ytilde_ini_oe_tf(:,2),...
                    S5.ytilde_ini_oe_tf(:,2),...
                    S6.ytilde_ini_oe_tf(:,2)...
                    );
rmse_oe_tf2 = RMSE(...
                    S1.ytilde_sec_oe_tf(:,2),...
                    S2.ytilde_sec_oe_tf(:,2),...
                    S3.ytilde_sec_oe_tf(:,2),...
                    S4.ytilde_sec_oe_tf(:,2),...S5.ytilde_sec_oe_tf(:,2),...
                    S6.ytilde_sec_oe_tf(:,2)...
                    );
rmse_oe_tf3 = RMSE(...
                    S1.ytilde_thi_oe_tf(:,2),...
                    S2.ytilde_thi_oe_tf(:,2),...
                    S3.ytilde_thi_oe_tf(:,2),...
                    S4.ytilde_thi_oe_tf(:,2),...S5.ytilde_thi_oe_tf(:,2),...
                    S6.ytilde_thi_oe_tf(:,2)...
                    );

rmse_spem1 = RMSE(...
                    S1.ytilde_ini_spem(:,2),...
                    S2.ytilde_ini_spem(:,2),...
                    S3.ytilde_ini_spem(:,2),...
                    S4.ytilde_ini_spem(:,2),...
                    S5.ytilde_ini_spem(:,2),...
                    S6.ytilde_ini_spem(:,2)...
                    );
rmse_spem2 = RMSE(...
                    S1.ytilde_sec_spem(:,2),...
                    S2.ytilde_sec_spem(:,2),...
                    S3.ytilde_sec_spem(:,2),...
                    S4.ytilde_sec_spem(:,2),...
                    S5.ytilde_sec_spem(:,2),...
                    S6.ytilde_sec_spem(:,2)...
                    );
rmse_spem3 = RMSE(...
                    S1.ytilde_thi_spem(:,2),...
                    S2.ytilde_thi_spem(:,2),...
                    S3.ytilde_thi_spem(:,2),...
                    S4.ytilde_thi_spem(:,2),...
                    S5.ytilde_thi_spem(:,2),...
                    S6.ytilde_thi_spem(:,2)...
                    );
%%
sys_zd_ini_spem = G_checkz_d(S1.sys_env, S1.sys_local,...
                                S1.IDsys_ini_spem, S1.controller_ini_spem{1}.K);
                
sys_zd_sec_spem = G_checkz_d(S1.sys_env, S1.sys_local,...
                                S1.IDsys_sec_spem, S1.controller_sec_spem{1}.K);

sys_zd_thi_spem = G_checkz_d(S1.sys_env, S1.sys_local,...
                                S1.IDsys_sec_spem, S1.controller_thi_spem{1}.K);

figure('position',[-900,0,600,600],'name','SPEM')
bode(sys_zd_ini_spem,sys_zd_sec_spem,sys_zd_thi_spem)
legend('Stage 2','Stage 4','Stage 5')
                            
sys_zd_ini_oe_ss = G_checkz_d(S1.sys_env, S1.sys_local,...
                                S1.IDsys_ini_oe_ss, S1.controller_ini_oe_ss{1}.K);
                
sys_zd_sec_oe_ss = G_checkz_d(S1.sys_env, S1.sys_local,...
                                S1.IDsys_sec_oe_ss, S1.controller_sec_oe_ss{1}.K);

sys_zd_thi_oe_ss = G_checkz_d(S1.sys_env, S1.sys_local,...
                                S1.IDsys_sec_oe_ss, S1.controller_thi_oe_ss{1}.K);
                            
figure('Position',[-900,0,600,600],'name','OE-SS')
bode(sys_zd_ini_oe_ss,sys_zd_sec_oe_ss,sys_zd_thi_oe_ss)
legend('Stage 2','Stage 4','Stage 5')


sys_zd_ini_oe_tf = G_checkz_d(S1.sys_env, S1.sys_local,...
                                S1.IDsys_ini_oe_tf, S1.controller_ini_oe_tf{1}.K);
                
sys_zd_sec_oe_tf = G_checkz_d(S1.sys_env, S1.sys_local,...
                                S1.IDsys_sec_oe_tf, S1.controller_sec_oe_tf{1}.K);

sys_zd_thi_oe_tf = G_checkz_d(S1.sys_env, S1.sys_local,...
                                S1.IDsys_sec_oe_tf, S1.controller_thi_oe_tf{1}.K);
                            
figure('Position',[-900,0,600,600],'name','OE-TF')
bode(sys_zd_ini_oe_tf,sys_zd_sec_oe_tf,sys_zd_thi_oe_tf)
legend('Stage 2','Stage 4','Stage 5')
%%
% % % % 

% % % max_itr = 1000;
% % % rng('shuffle')
% % % 
% % % yyy_oe_ss1 = 0;
% % % parfor_progress(max_itr);
% % % parfor itr = 1:max_itr
% % %     sim_noise = randn(S1.sim_N, 2);
% % %     tmp = lsim(S1.sys_sec_oe_ss(S1.ob_y_p, S1.ID_in_p), sim_noise, S1.t_s);
% % %     yyy_oe_ss1 = yyy_oe_ss1 + norm(tmp(:,2));
% % %     parfor_progress();
% % % end
% % % itr = round(parfor_progress()*max_itr/100);
% % % parfor_progress(0);
% % % 
% % % yyy_oe_ss1 = yyy_oe_ss1/itr
% % % 
% % % % % % % 
% % % 
% % % yyy_oe_ss2 = 0;
% % % parfor_progress(max_itr);
% % % parfor itr = 1:max_itr
% % %     sim_noise = randn(S1.sim_N, 2);
% % %     tmp = lsim(S1.sys_thi_oe_ss(S1.ob_y_p, S1.ID_in_p), sim_noise, S1.t_s);
% % %     yyy_oe_ss2 = yyy_oe_ss2 + norm(tmp(:,2));
% % %     parfor_progress();
% % % end
% % % itr = round(parfor_progress()*max_itr/100);
% % % parfor_progress(0);
% % % 
% % % yyy_oe_ss2 = yyy_oe_ss2/itr
% % % 
% % % % % % % % 
% % % yyy_spem1 = 0;
% % % parfor_progress(max_itr);
% % % parfor itr = 1:max_itr
% % %     sim_noise = randn(S1.sim_N, 2);
% % %     tmp = lsim(S1.sys_sec_spem(S1.ob_y_p, S1.ID_in_p), sim_noise, S1.t_s);
% % %     yyy_spem1 = yyy_spem1 + norm(tmp(:,2));
% % %     parfor_progress();
% % % end
% % % itr = round(parfor_progress()*max_itr/100);
% % % parfor_progress(0);
% % % 
% % % yyy_spem1 = yyy_spem1/itr
% % % 
% % % yyy_spem2 = 0;
% % % parfor_progress(max_itr);
% % % parfor itr = 1:max_itr
% % %     sim_noise = randn(S1.sim_N, 2);
% % %     tmp = lsim(S1.sys_thi_spem(S1.ob_y_p, S1.ID_in_p), sim_noise, S1.t_s)
% % %     yyy_spem2 = yyy_spem2 + norm(tmp(:,2));
% % %     parfor_progress();
% % % end
% % % itr = round(parfor_progress()*max_itr/100);
% % % parfor_progress(0);
% % % 
% % % yyy_spem2 = yyy_spem2/itr


%% Bode
% figure('Name','oe_ss_parallel_ini');
% bode(S1.sys_env,'r',S1.IDsys_ini_oe_ss,'b',S2.IDsys_ini_oe_ss,'b',S3.IDsys_ini_oe_ss,'b')
% figure('Name','spem_parallel_ini');
% bode(S1.sys_env,'r',S1.IDsys_ini_spem,'g',S2.IDsys_ini_spem,'g',S3.IDsys_ini_spem,'g')
%% local fnntion
function mse = RMSE(varargin)
    number = numel(varargin);
    mse = 0;
    for itr = 1 : number
        mse = mse + norm(varargin{itr});
    end
    mse = mse/number;
end
